# /etc/systemd/system/kubelet.service.d/bootstrap.conf
# (!!! To be templated by Terraform !!!)
# REF: https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/
[Service]
%{ if set_provider_id || set_node_ip ~}
EnvironmentFile=-/run/kubelet.env
ExecStartPre=/bin/sh -c '{ %{ if set_provider_id }echo "PROVIDER_ID=exoscale://$(wget -qO- http://169.254.169.254/1.0/meta-data/instance-id)"; %{ endif }%{ if set_node_ip }netplan ip leases eth1 | sed -n "s|^ADDRESS=|PRIVNET_IP=|p"; %{ endif }} > /run/kubelet.env'
%{ endif ~}
ExecStart=
ExecStart=/usr/bin/kubelet \
  --bootstrap-kubeconfig=/etc/kubernetes/kubelet/bootstrap.kubeconfig \
  --kubeconfig=/etc/kubernetes/kubelet/kubeconfig \
  --config=/etc/kubernetes/kubelet/config.yaml \
  --cloud-provider=external \
%{ if set_provider_id ~}
  --provider-id=$${PROVIDER_ID} \
%{ endif ~}
%{ if set_node_ip ~}
  --node-ip=$${PRIVNET_IP} \
%{ endif ~}
  --container-runtime-endpoint=unix:///run/containerd/containerd.sock
